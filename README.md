# Redis Tools

> Для работы требуется `redis-cli`

## redis-init

Скрипт для манипуляции инит скриптами кластера: старт, рестарт, т.д.

## redis-restore

- количество нод (и порты) скрипт берет из инит скриптов `/etc/init.d/redis*`
- архив (tar.gz) распаковывается в каталог `/tmp/<same directory>`
- предпологается что в архиве файлы лежат в каталоге `redis/*` (пример: `redis/7000/dump.rdb`)
- каталог кластера распаложен в `/var/lib/redis`

Изначально была задача перенести кластер с одного сервера на другой (на сервере запущено по экземпляру на ядро процессора). Предпологается, что конфигурация сервера таже (если запускать скрипт `redis-trib.rb` так оно и будет), т.е. такое же количество нод, там же конфиги кластера лежат. В общем всё так же, только данные перенести. Для этого нужно файлы RDB скопировать на новый сервер, а в файлах `/var/lib/redis/$REDISPORT/cluster.conf` поменять IP нод.

В этом случае команду нужно запустить так:

```shell
$ sudo ./redis-restore.sh -a <path to archive> -o <old IP> -n <new IP>
```

Если же нужно восстановить только RDB файлы с данными, то ключи `-o`/`-n` использовать не следует, оставив только `-a`. Шаг с заменой IP будет пропущен.

## redis-backup

Скрипт не имеет ключей запуска.

- количество нод (и порты) скрипт берет из инит скриптов `/etc/init.d/redis*`
- кластер "должен" лежать в каталоге `/var/lib/redis`
- будет создан каталог `/var/opt/redis` (mode: 0700)
- конечное имя архива `redis-cluster-2017-09-17-14-27-32.tar.gz`
- перед выполнением архивации выполняется команда `redis-cli -p <port> save`

## redis-bkrotate

Для ротации файлов с бэкапами. Есть два ключа: `-d` - где лежат бэкапы, по-умолчанию: `/var/opt/redis`) и `-o` - на сколько старые файлы удалять (ищет по маске `redis-cluster*`), по-умолчанию: `+7`.

## redis-mem

Показывает сколько памяти использует кластер редиса (пока только на одном хосте).

```shell
$ ./redis-mem.sh -u gb
168
```

## redis-cmd

> Не все команды были проверены, но большая часть точно должна работать без проблем.

Выполнение команды на всех нодах кластера (по умолчанию кластер состоит из 32 нод):

```shell
./redis-cmd.sh -c 'config set save "900 1 300 10 60 10000"'
```

Выполнить команду только на одной ноде (но зачеме, если есть родной `redis-cli`?):

```shell
$ ./redis-cmd.sh -p 7011 -n 1 -c 'config set save "900 1 300 10 60 10000"'
```

## redis-addr

>  Есть возможность делать бэкапы конфигов. В Linux имя файла выглядит так -- `cluster.conf.1515745858.840766875`, в macOS -- `cluster.conf.1515745858.`, Не думаю что у кого-то кластер Redis запущен на macOS :)

Скрипт меняет IP нод работающих в кластере (для примера: кластер собран из 32 нод на одном сервере). Т.е. на сервере есть два IP, кластер был собран на одном из этих IP, но потом рабочий кластер потребовалось перевести на другой IP -- как раз в этом случае этот скрипт сделает это быстро и легко.

Оставите работу кластера и выполните команду:

```shell
$ ./redis-addr.sh -O 1.2.3.4 -N 1.2.3.5
```

Есть дополнительные настройки (`-h`).

## License

MIT
